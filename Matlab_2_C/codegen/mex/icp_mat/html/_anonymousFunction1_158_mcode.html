<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type0" id="S2T0U3">Tt</span>, <span class="var type0" id="S3T0U4">Tr</span>, <span class="var type0" id="S4T0U5">ER</span>, <span class="var type0" id="S5T0U6">t</span>] = icp_mat(<span class="var type0" id="S6T0U9">q</span>,<span class="var type0" id="S7T0U10">p</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% 输入变量，因为原版的是通过inputParser，这个在Matlab coder中不识别，所以这边略去这个部分，直接给输入变量赋值</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="var type0" id="S8T0U14">arg</span>.Boundary = [];</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="var type0" id="S8T0U21">arg</span>.EdgeRejection = false;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="var type0" id="S8T0U28">arg</span>.Extrapolation = true;		<span class="comment">% false</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="var type0" id="S8T0U35">arg</span>.iter = 15;					<span class="comment">% 迭代次数，默认10次</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="var type0" id="S8T0U41">arg</span>.Matching = <span class="string">'bruteForce'</span>;	<span class="comment">% 控制点匹配手法，注意这里只有暴力匹配能被Matlab Coder使用，其他手段都不能用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="var type0" id="S8T0U47">arg</span>.Minimize = <span class="string">'point'</span>;	</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="var type0" id="S8T0U53">arg</span>.Normals = [];</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="var type0" id="S8T0U60">arg</span>.p = <span class="var type0" id="S7T0U62">p</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="var type0" id="S8T0U66">arg</span>.q = <span class="var type0" id="S6T0U68">q</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="var type0" id="S8T0U72">arg</span>.ReturnAll = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="var type0" id="S8T0U78">arg</span>.Triangulation = [];</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="var type0" id="S8T0U85">arg</span>.Verbose = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="var type0" id="S8T0U91">arg</span>.Weight = <span class="mxinfo " id="T37:U1">@(<span class="mxinfo " id="T18:U2">x</span>)<span class="mxinfo " id="T18:U3">ones(<span class="mxinfo " id="T4:U4">1</span>,<span class="mxinfo " id="T4:U5">length(<span class="mxinfo " id="T18:U6">x</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="var type0" id="S8T0U104">arg</span>.WorstRejection = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">% Actual implementation 实际应用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% Allocate vector for RMS of errors in every iteration.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% 这个t是结果用来统计均方根误差用的，这里完全可以不要，因为在Matlab Coder内不识别</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">% t = zeros(arg.iter+1,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="var type0" id="S5T0U109">t</span> = 0;							<span class="comment">% 只好这里放弃，在C里面再增加值进行测试</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">% Start timer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">% tic;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="var type0" id="S13T0U113">Np</span> = size(<span class="var type0" id="S7T0U116">p</span>,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">% Transformed data point cloud</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="var type0" id="S15T0U120">pt</span> = <span class="var type0" id="S7T0U121">p</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">% Allocate vector for RMS of errors in every iteration.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="var type0" id="S4T0U124">ER</span> = zeros(<span class="var type0" id="S8T0U129">arg</span>.iter+1,1); </span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">% Initialize temporary transform vector and matrix.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="var type0" id="S17T0U135">T</span> = zeros(3,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="var type0" id="S18T0U142">R</span> = eye(3,3);</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% Initialize total transform vector(s) and rotation matric(es).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="var type0" id="S20T0U149">TT</span> = zeros(3,1, <span class="var type0" id="S8T0U156">arg</span>.iter+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="var type0" id="S21T0U161">TR</span> = repmat(eye(3,3), [1,1, <span class="var type0" id="S8T0U174">arg</span>.iter+1]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="var type0" id="S2T0U179">Tt</span> = zeros(3, 1);			<span class="comment">% 这两个变量是用于返回的，上面两个是过程变量</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="var type0" id="S3T0U186">Tr</span> = zeros(3, 3);			<span class="comment">% 之所以这么做是因为Matlab在返回的时候会报Mismatch</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">% If edge vertices should be rejected, find edge vertices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="keyword">if</span> <span class="var type0" id="S8T0U194">arg</span>.EdgeRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type0" id="S8T0U201">arg</span>.Boundary)</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">        <span class="var type0" id="S24T0U205">bdr</span> = find_bound(<span class="var type0" id="S6T0U208">q</span>, <span class="var type0" id="S8T0U210">arg</span>.Triangulation);</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">        <span class="var type0" id="S24T0U215">bdr</span> = <span class="var type0" id="S8T0U217">arg</span>.Boundary;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="keyword">if</span> <span class="var type0" id="S8T0U222">arg</span>.Extrapolation</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">    <span class="comment">% Initialize total transform vector (quaternion ; translation vec.)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">    <span class="var type0" id="S26T0U226">qq</span> = [ones(1,<span class="var type0" id="S8T0U234">arg</span>.iter+1);zeros(6,<span class="var type0" id="S8T0U243">arg</span>.iter+1)];   </span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">    <span class="comment">% Allocate vector for direction change and change angle.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">    <span class="var type0" id="S27T0U248">dq</span> = zeros(7,<span class="var type0" id="S8T0U254">arg</span>.iter+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">    <span class="var type0" id="S28T0U259">theta</span> = zeros(1,<span class="var type0" id="S8T0U265">arg</span>.iter+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%t(1) = toc;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% Go into main iteration loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S29T0U270">k</span>=1:<span class="var type0" id="S8T0U274">arg</span>.iter</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">    <span class="comment">% Do matching</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">    <span class="keyword">switch</span> <span class="var type0" id="S8T0U278">arg</span>.Matching</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">        <span class="keyword">case</span> <span class="string">'bruteForce'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">            [<span class="var type0" id="S30T0U285">match</span> <span class="var type0" id="S31T0U286">mindist</span>] = match_bruteForce(<span class="var type0" id="S6T0U289">q</span>,<span class="var type0" id="S15T0U290">pt</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">%        case 'Delaunay'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">%            [match mindist] = match_Delaunay(q,pt,DT);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">%        case 'kDtree'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">%            [match mindist] = match_kDtree(q,pt,kdOBJ);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">	<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">	<span class="comment">% If matches to edge vertices should be rejected</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="keyword">if</span> <span class="var type0" id="S8T0U294">arg</span>.EdgeRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">        <span class="var type0" id="S33T0U298">p_idx</span> = not(ismember(<span class="var type0" id="S30T0U303">match</span>, <span class="var type0" id="S24T0U304">bdr</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">        <span class="var type0" id="S36T0U307">q_idx</span> = <span class="var type0" id="S30T0U309">match</span>(<span class="var type0" id="S33T0U310">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">        <span class="var type0" id="S31T0U313">mindist</span> = <span class="var type0" id="S31T0U315">mindist</span>(<span class="var type0" id="S33T0U316">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">        <span class="var type0" id="S33T0U320">p_idx</span> = true(1, <span class="var type0" id="S13T0U324">Np</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">        <span class="var type0" id="S36T0U327">q_idx</span> = <span class="var type0" id="S30T0U328">match</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">    <span class="comment">% If worst matches should be rejected</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">    <span class="keyword">if</span> <span class="var type0" id="S8T0U332">arg</span>.WorstRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">        <span class="var type0" id="S37T0U336">edge</span> = round((1-<span class="var type0" id="S8T0U344">arg</span>.WorstRejection)*sum(<span class="var type0" id="S33T0U348">p_idx</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">        <span class="var type0" id="S40T0U351">pairs</span> = find(<span class="var type0" id="S33T0U354">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">        [~, <span class="var type0" id="S42T0U359">idx</span>] = sort(<span class="var type0" id="S31T0U362">mindist</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">        <span class="var type0" id="S33T0U366">p_idx</span>(<span class="var type0" id="S40T0U368">pairs</span>(<span class="var type0" id="S42T0U370">idx</span>(<span class="var type0" id="S37T0U372">edge</span>:end))) = false;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">        <span class="var type0" id="S36T0U379">q_idx</span> = <span class="var type0" id="S30T0U381">match</span>(<span class="var type0" id="S33T0U382">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">        <span class="var type0" id="S31T0U385">mindist</span> = <span class="var type0" id="S31T0U387">mindist</span>(<span class="var type0" id="S33T0U388">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">	<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">	<span class="keyword">if</span> <span class="var type0" id="S29T0U392">k</span> == 1</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">        <span class="var type0" id="S4T0U397">ER</span>(<span class="var type0" id="S29T0U398">k</span>) = sqrt(sum(<span class="var type0" id="S31T0U405">mindist</span>.^2)/length(<span class="var type0" id="S31T0U409">mindist</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">	<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">	<span class="keyword">switch</span> <span class="var type0" id="S8T0U412">arg</span>.Minimize</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">        <span class="keyword">case</span> <span class="string">'point'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">            <span class="comment">% Determine weight vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">            <span class="var type0" id="S46T0U418">weights</span> = <span class="var type0" id="S8T0U421">arg</span>.Weight(<span class="var type0" id="S30T0U423">match</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">            [<span class="var type0" id="S18T0U427">R</span>,<span class="var type0" id="S17T0U428">T</span>] = eq_point(<span class="var type0" id="S6T0U432">q</span>(:,<span class="var type0" id="S36T0U434">q_idx</span>),<span class="var type0" id="S15T0U436">pt</span>(:,<span class="var type0" id="S33T0U438">p_idx</span>), <span class="var type0" id="S46T0U440">weights</span>(<span class="var type0" id="S33T0U441">p_idx</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">%        case 'plane'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="comment">%            weights = arg.Weight(match);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">%            [R,T] = eq_plane(q(:,q_idx),pt(:,p_idx),arg.Normals(:,q_idx),weights(p_idx));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%        case 'lmaPoint'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="comment">%            [R,T] = eq_lmaPoint(q(:,q_idx),pt(:,p_idx));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">	<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">    <span class="comment">% Add to the total transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">    <span class="var type0" id="S21T0U445">TR</span>(:,:,<span class="var type0" id="S29T0U449">k</span>+1) = <span class="var type0" id="S18T0U452">R</span>*<span class="var type0" id="S21T0U454">TR</span>(:,:,<span class="var type0" id="S29T0U457">k</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">    <span class="var type0" id="S20T0U461">TT</span>(:,:,<span class="var type0" id="S29T0U465">k</span>+1) = <span class="var type0" id="S18T0U469">R</span>*<span class="var type0" id="S20T0U471">TT</span>(:,:,<span class="var type0" id="S29T0U474">k</span>)+<span class="var type0" id="S17T0U475">T</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="comment">% Apply last transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    <span class="var type0" id="S15T0U478">pt</span> = <span class="var type0" id="S21T0U482">TR</span>(:,:,<span class="var type0" id="S29T0U486">k</span>+1) * <span class="var type0" id="S7T0U488">p</span> + repmat(<span class="var type0" id="S20T0U492">TT</span>(:,:,<span class="var type0" id="S29T0U496">k</span>+1), 1, <span class="var type0" id="S13T0U499">Np</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="comment">% Root mean of objective function </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    <span class="var type0" id="S4T0U503">ER</span>(<span class="var type0" id="S29T0U505">k</span>+1) = rms_error(<span class="var type0" id="S6T0U510">q</span>(:,<span class="var type0" id="S36T0U512">q_idx</span>), <span class="var type0" id="S15T0U514">pt</span>(:,<span class="var type0" id="S33T0U516">p_idx</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    <span class="comment">% If Extrapolation, we might be able to move quicker</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="keyword">if</span> <span class="var type0" id="S8T0U520">arg</span>.Extrapolation</span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">        <span class="var type0" id="S26T0U525">qq</span>(:,<span class="var type0" id="S29T0U528">k</span>+1) = [rmat2quat(<span class="var type0" id="S21T0U535">TR</span>(:,:,<span class="var type0" id="S29T0U539">k</span>+1));<span class="var type0" id="S20T0U543">TT</span>(:,:,<span class="var type0" id="S29T0U547">k</span>+1)];</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">        <span class="var type0" id="S27T0U552">dq</span>(:,<span class="var type0" id="S29T0U555">k</span>+1) = <span class="var type0" id="S26T0U559">qq</span>(:,<span class="var type0" id="S29T0U562">k</span>+1) - <span class="var type0" id="S26T0U565">qq</span>(:,<span class="var type0" id="S29T0U567">k</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">        <span class="var type0" id="S28T0U571">theta</span>(<span class="var type0" id="S29T0U573">k</span>+1) = (180/pi)*acos(dot(<span class="var type0" id="S27T0U587">dq</span>(:,<span class="var type0" id="S29T0U589">k</span>),<span class="var type0" id="S27T0U591">dq</span>(:,<span class="var type0" id="S29T0U594">k</span>+1))/(norm(<span class="var type0" id="S27T0U601">dq</span>(:,<span class="var type0" id="S29T0U603">k</span>))*norm(<span class="var type0" id="S27T0U607">dq</span>(:,<span class="var type0" id="S29T0U610">k</span>+1))));</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">        <span class="keyword">if</span> <span class="var type0" id="S8T0U615">arg</span>.Verbose</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">            disp([<span class="string">'Direction change '</span> num2str(<span class="var type0" id="S28T0U626">theta</span>(<span class="var type0" id="S29T0U628">k</span>+1)) <span class="string">' degree in iteration '</span> num2str(<span class="var type0" id="S29T0U633">k</span>)]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">        <span class="keyword">if</span> <span class="var type0" id="S29T0U639">k</span>&gt;2 &amp;&amp; <span class="var type0" id="S28T0U643">theta</span>(<span class="var type0" id="S29T0U645">k</span>+1) &lt; 10 &amp;&amp; <span class="var type0" id="S28T0U650">theta</span>(<span class="var type0" id="S29T0U651">k</span>) &lt; 10</span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">            <span class="var type0" id="S56T0U655">d</span> = [<span class="var type0" id="S4T0U659">ER</span>(<span class="var type0" id="S29T0U661">k</span>+1), <span class="var type0" id="S4T0U664">ER</span>(<span class="var type0" id="S29T0U665">k</span>), <span class="var type0" id="S4T0U667">ER</span>(<span class="var type0" id="S29T0U669">k</span>-1)];</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">            <span class="var type0" id="S57T0U673">v</span> = [0, -norm(<span class="var type0" id="S27T0U681">dq</span>(:,<span class="var type0" id="S29T0U684">k</span>+1)), -norm(<span class="var type0" id="S27T0U691">dq</span>(:,<span class="var type0" id="S29T0U693">k</span>))-norm(<span class="var type0" id="S27T0U697">dq</span>(:,<span class="var type0" id="S29T0U700">k</span>+1))];</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">            <span class="var type0" id="S58T0U704">vmax</span> = 25 * norm(<span class="var type0" id="S27T0U710">dq</span>(:,<span class="var type0" id="S29T0U713">k</span>+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">            <span class="var type0" id="S59T0U717">dv</span> = extrapolate(<span class="var type0" id="S57T0U720">v</span>,<span class="var type0" id="S56T0U721">d</span>,<span class="var type0" id="S58T0U722">vmax</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">            <span class="keyword">if</span> <span class="var type0" id="S59T0U726">dv</span> ~= 0</span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">                <span class="var type0" id="S61T0U730">q_mark</span> = <span class="var type0" id="S26T0U733">qq</span>(:,<span class="var type0" id="S29T0U736">k</span>+1) + <span class="var type0" id="S59T0U740">dv</span> * <span class="var type0" id="S27T0U742">dq</span>(:,<span class="var type0" id="S29T0U745">k</span>+1)/norm(<span class="var type0" id="S27T0U750">dq</span>(:,<span class="var type0" id="S29T0U753">k</span>+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">                <span class="var type0" id="S61T0U758">q_mark</span>(1:4) = <span class="var type0" id="S61T0U764">q_mark</span>(1:4)/norm(<span class="var type0" id="S61T0U771">q_mark</span>(1:4));</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">                <span class="var type0" id="S26T0U778">qq</span>(:,<span class="var type0" id="S29T0U781">k</span>+1) = <span class="var type0" id="S61T0U783">q_mark</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">                <span class="var type0" id="S21T0U787">TR</span>(:,:,<span class="var type0" id="S29T0U791">k</span>+1) = quat2rmat(<span class="var type0" id="S26T0U796">qq</span>(1:4,<span class="var type0" id="S29T0U801">k</span>+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">                <span class="var type0" id="S20T0U806">TT</span>(:,:,<span class="var type0" id="S29T0U810">k</span>+1) = <span class="var type0" id="S26T0U813">qq</span>(5:7,<span class="var type0" id="S29T0U818">k</span>+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">                <span class="comment">% Reapply total transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">                <span class="var type0" id="S15T0U822">pt</span> = <span class="var type0" id="S21T0U826">TR</span>(:,:,<span class="var type0" id="S29T0U830">k</span>+1) * <span class="var type0" id="S7T0U832">p</span> + repmat(<span class="var type0" id="S20T0U836">TT</span>(:,:,<span class="var type0" id="S29T0U840">k</span>+1), 1, <span class="var type0" id="S13T0U843">Np</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">                <span class="comment">% Recalculate root mean of objective function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">                <span class="comment">% Note this is costly and only for fun!</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">                <span class="keyword">switch</span> <span class="var type0" id="S8T0U846">arg</span>.Matching</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">                    <span class="keyword">case</span> <span class="string">'bruteForce'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">                        [~, <span class="var type0" id="S31T0U854">mindist</span>] = match_bruteForce(<span class="var type0" id="S6T0U857">q</span>,<span class="var type0" id="S15T0U858">pt</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="comment">%                    case 'Delaunay'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="comment">%                        [~, mindist] = match_Delaunay(q,pt,DT);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="comment">%                    case 'kDtree'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"><span class="comment">%                        [~, mindist] = match_kDtree(q,pt,kdOBJ);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">                <span class="var type0" id="S4T0U862">ER</span>(<span class="var type0" id="S29T0U864">k</span>+1) = sqrt(sum(<span class="var type0" id="S31T0U872">mindist</span>.^2)/length(<span class="var type0" id="S31T0U876">mindist</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">    <span class="comment">% t(k+1) = toc;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line"><span class="var type0" id="S3T0U879">Tr</span> = <span class="var type0" id="S21T0U881">TR</span>(:,:,end);</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"><span class="var type0" id="S2T0U888">Tt</span> = <span class="var type0" id="S20T0U890">TT</span>(:,:,end);</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"><span class="comment">%if not(arg.ReturnAll)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"><span class="comment">%	% 原来这样在Matlab Coder里会报Mismatch，这边只好加入一个临时变量，用于返回</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"><span class="comment">%   % 这段也弃用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"><span class="comment">%    TR = TR(:,:,end);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="comment">%    TT = TT(:,:,end);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"><span class="comment">% 暴力匹配</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line"><span class="keyword">function</span> [<span class="var type0" id="S64T0U897">match</span> <span class="var type0" id="S65T0U898">mindist</span>] = match_bruteForce(<span class="var type0" id="S66T0U901">q</span>, <span class="var type0" id="S67T0U902">p</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">    <span class="var type0" id="S68T0U905">m</span> = size(<span class="var type0" id="S67T0U908">p</span>,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">    <span class="var type0" id="S70T0U912">n</span> = size(<span class="var type0" id="S66T0U915">q</span>,2);    </span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">    <span class="var type0" id="S64T0U919">match</span> = zeros(1,<span class="var type0" id="S68T0U923">m</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">    <span class="var type0" id="S65T0U926">mindist</span> = zeros(1,<span class="var type0" id="S68T0U930">m</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">    <span class="keyword">for</span> <span class="var type0" id="S72T0U933">ki</span>=1:<span class="var type0" id="S68T0U936">m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">        <span class="var type0" id="S73T0U939">d</span>=zeros(1,<span class="var type0" id="S70T0U943">n</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">        <span class="keyword">for</span> <span class="var type0" id="S74T0U946">ti</span>=1:3</span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">            <span class="var type0" id="S73T0U952">d</span>=<span class="var type0" id="S73T0U954">d</span>+(<span class="var type0" id="S66T0U959">q</span>(<span class="var type0" id="S74T0U960">ti</span>,:)-<span class="var type0" id="S67T0U963">p</span>(<span class="var type0" id="S74T0U964">ti</span>,<span class="var type0" id="S72T0U965">ki</span>)).^2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">        [<span class="var type0" id="S65T0U971">mindist</span>(<span class="var type0" id="S72T0U972">ki</span>),<span class="var type0" id="S64T0U974">match</span>(<span class="var type0" id="S72T0U975">ki</span>)]=min(<span class="var type0" id="S73T0U978">d</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    <span class="var type0" id="S65T0U981">mindist</span> = sqrt(<span class="var type0" id="S65T0U984">mindist</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line"><span class="keyword">function</span> [<span class="var type0" id="S78T0U987">R</span>,<span class="var type0" id="S79T0U988">T</span>] = eq_point(<span class="var type0" id="S80T0U991">q</span>,<span class="var type0" id="S81T0U992">p</span>,<span class="var type0" id="S82T0U993">weights</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line"><span class="var type0" id="S83T0U996">m</span> = size(<span class="var type0" id="S81T0U999">p</span>,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line"><span class="var type0" id="S85T0U1003">n</span> = size(<span class="var type0" id="S80T0U1006">q</span>,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="comment">% normalize weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line"><span class="var type0" id="S82T0U1010">weights</span> = <span class="var type0" id="S82T0U1012">weights</span> ./ sum(<span class="var type0" id="S82T0U1015">weights</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"><span class="comment">% find data centroid and deviations from centroid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line"><span class="var type0" id="S87T0U1018">q_bar</span> = <span class="var type0" id="S80T0U1020">q</span> * transpose(<span class="var type0" id="S82T0U1023">weights</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line"><span class="var type0" id="S89T0U1026">q_mark</span> = <span class="var type0" id="S80T0U1028">q</span> - repmat(<span class="var type0" id="S87T0U1031">q_bar</span>, 1, <span class="var type0" id="S85T0U1033">n</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line"><span class="comment">% Apply weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line"><span class="var type0" id="S89T0U1036">q_mark</span> = <span class="var type0" id="S89T0U1038">q_mark</span> .* repmat(<span class="var type0" id="S82T0U1041">weights</span>, 3, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line"><span class="comment">% find data centroid and deviations from centroid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line"><span class="var type0" id="S91T0U1046">p_bar</span> = <span class="var type0" id="S81T0U1048">p</span> * transpose(<span class="var type0" id="S82T0U1051">weights</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line"><span class="var type0" id="S92T0U1054">p_mark</span> = <span class="var type0" id="S81T0U1056">p</span> - repmat(<span class="var type0" id="S91T0U1059">p_bar</span>, 1, <span class="var type0" id="S83T0U1061">m</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"><span class="comment">% Apply weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"><span class="comment">%p_mark = p_mark .* repmat(weights, 3, 1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line"><span class="var type0" id="S93T0U1064">N</span> = <span class="var type0" id="S92T0U1066">p_mark</span>*transpose(<span class="var type0" id="S89T0U1069">q_mark</span>); <span class="comment">% taking points of q in matched order</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line">[<span class="var type0" id="S94T0U1073">U</span>,~,<span class="var type0" id="S95T0U1075">V</span>] = svd(<span class="var type0" id="S93T0U1078">N</span>); <span class="comment">% singular value decomposition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line"><span class="var type0" id="S78T0U1081">R</span> = <span class="var type0" id="S95T0U1084">V</span>*diag([1 1 det(<span class="var type0" id="S94T0U1094">U</span>*<span class="var type0" id="S95T0U1096">V</span>')])*transpose(<span class="var type0" id="S94T0U1099">U</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line"><span class="var type0" id="S79T0U1102">T</span> = <span class="var type0" id="S87T0U1104">q_bar</span> - <span class="var type0" id="S78T0U1106">R</span>*<span class="var type0" id="S91T0U1107">p_bar</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line"><span class="comment">% Extrapolation in quaternion space. Details are found in:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line"><span class="comment">% Besl, P., &amp; McKay, N. (1992). A method for registration of 3-D shapes. </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line"><span class="comment">% IEEE Transactions on pattern analysis and machine intelligence, 239?256.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line"><span class="keyword">function</span> [<span class="var type0" id="S100T0U1110">dv</span>] = extrapolate(<span class="var type0" id="S101T0U1113">v</span>,<span class="var type0" id="S102T0U1114">d</span>,<span class="var type0" id="S103T0U1115">vmax</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line"><span class="var type0" id="S104T0U1118">p1</span> = polyfit(<span class="var type0" id="S101T0U1121">v</span>,<span class="var type0" id="S102T0U1122">d</span>,1); <span class="comment">% linear fit</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line"><span class="var type0" id="S106T0U1126">p2</span> = polyfit(<span class="var type0" id="S101T0U1129">v</span>,<span class="var type0" id="S102T0U1130">d</span>,2); <span class="comment">% parabolic fit</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line"><span class="var type0" id="S107T0U1134">v1</span> = -<span class="var type0" id="S104T0U1138">p1</span>(2)/<span class="var type0" id="S104T0U1141">p1</span>(1); <span class="comment">% linear zero crossing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line"><span class="var type0" id="S108T0U1145">v2</span> = -<span class="var type0" id="S106T0U1149">p2</span>(2)/(2*<span class="var type0" id="S106T0U1155">p2</span>(1)); <span class="comment">% polynomial top point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line"><span class="keyword">if</span> issorted([0 <span class="var type0" id="S108T0U1165">v2</span> <span class="var type0" id="S107T0U1166">v1</span> <span class="var type0" id="S103T0U1167">vmax</span>]) || issorted([0 <span class="var type0" id="S108T0U1173">v2</span> <span class="var type0" id="S103T0U1174">vmax</span> <span class="var type0" id="S107T0U1175">v1</span>])</span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line">    disp(<span class="string">'Parabolic update!'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line">    <span class="var type0" id="S100T0U1182">dv</span> = <span class="var type0" id="S108T0U1183">v2</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line"><span class="keyword">elseif</span> issorted([0 <span class="var type0" id="S107T0U1192">v1</span> <span class="var type0" id="S108T0U1193">v2</span> <span class="var type0" id="S103T0U1194">vmax</span>]) || issorted([0 <span class="var type0" id="S107T0U1200">v1</span> <span class="var type0" id="S103T0U1201">vmax</span> <span class="var type0" id="S108T0U1202">v2</span>])<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line">        || (<span class="var type0" id="S108T0U1206">v2</span> &lt; 0 &amp;&amp; issorted([0 <span class="var type0" id="S107T0U1213">v1</span> <span class="var type0" id="S103T0U1214">vmax</span>]))</span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line">    disp(<span class="string">'Line based update!'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line">    <span class="var type0" id="S100T0U1221">dv</span> = <span class="var type0" id="S107T0U1222">v1</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line"><span class="keyword">elseif</span> <span class="var type0" id="S107T0U1226">v1</span> &gt; <span class="var type0" id="S103T0U1227">vmax</span> &amp;&amp; <span class="var type0" id="S108T0U1229">v2</span> &gt; <span class="var type0" id="S103T0U1230">vmax</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line">    disp(<span class="string">'Maximum update!'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line">    <span class="var type0" id="S100T0U1237">dv</span> = <span class="var type0" id="S103T0U1238">vmax</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line">    disp(<span class="string">'No extrapolation!'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line">    <span class="var type0" id="S100T0U1246">dv</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,252" id="srcline252">252</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,253" id="srcline253">253</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,254" id="srcline254">254</a></span><span class="line"><span class="comment">% Determine the RMS error between two point equally sized point clouds with</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,255" id="srcline255">255</a></span><span class="line"><span class="comment">% point correspondance.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,256" id="srcline256">256</a></span><span class="line"><span class="comment">% ER = rms_error(p1,p2) where p1 and p2 are 3xn matrices.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,257" id="srcline257">257</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,258" id="srcline258">258</a></span><span class="line"><span class="keyword">function</span> <span class="var type0" id="S112T0U1250">ER</span> = rms_error(<span class="var type0" id="S113T0U1253">p1</span>,<span class="var type0" id="S114T0U1254">p2</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,259" id="srcline259">259</a></span><span class="line"><span class="var type0" id="S115T0U1257">dsq</span> = sum(power(<span class="var type0" id="S113T0U1263">p1</span> - <span class="var type0" id="S114T0U1264">p2</span>, 2),1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,260" id="srcline260">260</a></span><span class="line"><span class="var type0" id="S112T0U1269">ER</span> = sqrt(mean(<span class="var type0" id="S115T0U1274">dsq</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,261" id="srcline261">261</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,262" id="srcline262">262</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,263" id="srcline263">263</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,264" id="srcline264">264</a></span><span class="line"><span class="comment">% Converts (orthogonal) rotation matrices R to (unit) quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,265" id="srcline265">265</a></span><span class="line"><span class="comment">% representations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,266" id="srcline266">266</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,267" id="srcline267">267</a></span><span class="line"><span class="comment">% Input: A 3x3xn matrix of rotation matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,268" id="srcline268">268</a></span><span class="line"><span class="comment">% Output: A 4xn matrix of n corresponding quaternions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,269" id="srcline269">269</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,270" id="srcline270">270</a></span><span class="line"><span class="comment">% http://en.wikipedia.org/wiki/Rotation_matrix#Quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,271" id="srcline271">271</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,272" id="srcline272">272</a></span><span class="line"><span class="keyword">function</span> <span class="var type0" id="S121T0U1277">quaternion</span> = rmat2quat(<span class="var type0" id="S122T0U1280">R</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,273" id="srcline273">273</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,274" id="srcline274">274</a></span><span class="line"><span class="var type0" id="S123T0U1283">Qxx</span> = <span class="var type0" id="S122T0U1285">R</span>(1,1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,275" id="srcline275">275</a></span><span class="line"><span class="var type0" id="S124T0U1291">Qxy</span> = <span class="var type0" id="S122T0U1293">R</span>(1,2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,276" id="srcline276">276</a></span><span class="line"><span class="var type0" id="S125T0U1299">Qxz</span> = <span class="var type0" id="S122T0U1301">R</span>(1,3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,277" id="srcline277">277</a></span><span class="line"><span class="var type0" id="S126T0U1307">Qyx</span> = <span class="var type0" id="S122T0U1309">R</span>(2,1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line"><span class="var type0" id="S127T0U1315">Qyy</span> = <span class="var type0" id="S122T0U1317">R</span>(2,2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line"><span class="var type0" id="S128T0U1323">Qyz</span> = <span class="var type0" id="S122T0U1325">R</span>(2,3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line"><span class="var type0" id="S129T0U1331">Qzx</span> = <span class="var type0" id="S122T0U1333">R</span>(3,1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line"><span class="var type0" id="S130T0U1339">Qzy</span> = <span class="var type0" id="S122T0U1341">R</span>(3,2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line"><span class="var type0" id="S131T0U1347">Qzz</span> = <span class="var type0" id="S122T0U1349">R</span>(3,3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line"><span class="var type0" id="S132T0U1355">w</span> = 0.5 * sqrt(1+<span class="var type0" id="S123T0U1364">Qxx</span>+<span class="var type0" id="S127T0U1365">Qyy</span>+<span class="var type0" id="S131T0U1366">Qzz</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line"><span class="var type0" id="S134T0U1369">x</span> = 0.5 * sign(<span class="var type0" id="S130T0U1376">Qzy</span>-<span class="var type0" id="S128T0U1377">Qyz</span>) .* sqrt(1+<span class="var type0" id="S123T0U1384">Qxx</span>-<span class="var type0" id="S127T0U1385">Qyy</span>-<span class="var type0" id="S131T0U1386">Qzz</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line"><span class="var type0" id="S136T0U1389">y</span> = 0.5 * sign(<span class="var type0" id="S125T0U1396">Qxz</span>-<span class="var type0" id="S129T0U1397">Qzx</span>) .* sqrt(1-<span class="var type0" id="S123T0U1404">Qxx</span>+<span class="var type0" id="S127T0U1405">Qyy</span>-<span class="var type0" id="S131T0U1406">Qzz</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line"><span class="var type0" id="S137T0U1409">z</span> = 0.5 * sign(<span class="var type0" id="S126T0U1416">Qyx</span>-<span class="var type0" id="S124T0U1417">Qxy</span>) .* sqrt(1-<span class="var type0" id="S123T0U1424">Qxx</span>-<span class="var type0" id="S127T0U1425">Qyy</span>+<span class="var type0" id="S131T0U1426">Qzz</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line"><span class="var type0" id="S121T0U1429">quaternion</span> = reshape([<span class="var type0" id="S132T0U1434">w</span>;<span class="var type0" id="S134T0U1436">x</span>;<span class="var type0" id="S136T0U1438">y</span>;<span class="var type0" id="S137T0U1440">z</span>],4,[]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line"><span class="comment">% Converts (unit) quaternion representations to (orthogonal) rotation matrices R</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line"><span class="comment">% Input: A 4xn matrix of n quaternions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line"><span class="comment">% Output: A 3x3xn matrix of corresponding rotation matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,297" id="srcline297">297</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,298" id="srcline298">298</a></span><span class="line"><span class="comment">% http://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation#From_a_quaternion_to_an_orthogonal_matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,299" id="srcline299">299</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,300" id="srcline300">300</a></span><span class="line"><span class="keyword">function</span> <span class="var type0" id="S140T0U1446">R</span> = quat2rmat(<span class="var type0" id="S141T0U1449">quaternion</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,301" id="srcline301">301</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,302" id="srcline302">302</a></span><span class="line"><span class="comment">% 这里增加一个初始化，这边敢这么设置是因为这个东西本身就是二维的</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,303" id="srcline303">303</a></span><span class="line"><span class="var type0" id="S142T0U1452">q0</span> = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,304" id="srcline304">304</a></span><span class="line"><span class="var type0" id="S144T0U1460">qx</span> = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,305" id="srcline305">305</a></span><span class="line"><span class="var type0" id="S145T0U1468">qy</span> = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,306" id="srcline306">306</a></span><span class="line"><span class="var type0" id="S146T0U1476">qz</span> = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,307" id="srcline307">307</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,308" id="srcline308">308</a></span><span class="line"><span class="var type0" id="S142T0U1485">q0</span>(1,1,:) = <span class="var type0" id="S141T0U1490">quaternion</span>(1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,309" id="srcline309">309</a></span><span class="line"><span class="var type0" id="S144T0U1496">qx</span>(1,1,:) = <span class="var type0" id="S141T0U1501">quaternion</span>(2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,310" id="srcline310">310</a></span><span class="line"><span class="var type0" id="S145T0U1507">qy</span>(1,1,:) = <span class="var type0" id="S141T0U1512">quaternion</span>(3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,311" id="srcline311">311</a></span><span class="line"><span class="var type0" id="S146T0U1518">qz</span>(1,1,:) = <span class="var type0" id="S141T0U1523">quaternion</span>(4,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,312" id="srcline312">312</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,313" id="srcline313">313</a></span><span class="line"><span class="var type0" id="S140T0U1528">R</span> = [<span class="var type0" id="S142T0U1535">q0</span>.^2+<span class="var type0" id="S144T0U1538">qx</span>.^2-<span class="var type0" id="S145T0U1541">qy</span>.^2-<span class="var type0" id="S146T0U1544">qz</span>.^2 2*<span class="var type0" id="S144T0U1550">qx</span>.*<span class="var type0" id="S145T0U1551">qy</span>-2*<span class="var type0" id="S142T0U1555">q0</span>.*<span class="var type0" id="S146T0U1556">qz</span> 2*<span class="var type0" id="S144T0U1561">qx</span>.*<span class="var type0" id="S146T0U1562">qz</span>+2*<span class="var type0" id="S142T0U1566">q0</span>.*<span class="var type0" id="S145T0U1567">qy</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,314" id="srcline314">314</a></span><span class="line">     2*<span class="var type0" id="S144T0U1573">qx</span>.*<span class="var type0" id="S145T0U1574">qy</span>+2*<span class="var type0" id="S142T0U1578">q0</span>.*<span class="var type0" id="S146T0U1579">qz</span> <span class="var type0" id="S142T0U1584">q0</span>.^2-<span class="var type0" id="S144T0U1587">qx</span>.^2+<span class="var type0" id="S145T0U1590">qy</span>.^2-<span class="var type0" id="S146T0U1593">qz</span>.^2 2*<span class="var type0" id="S145T0U1599">qy</span>.*<span class="var type0" id="S146T0U1600">qz</span>-2*<span class="var type0" id="S142T0U1604">q0</span>.*<span class="var type0" id="S144T0U1605">qx</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,315" id="srcline315">315</a></span><span class="line">     2*<span class="var type0" id="S144T0U1611">qx</span>.*<span class="var type0" id="S146T0U1612">qz</span>-2*<span class="var type0" id="S142T0U1616">q0</span>.*<span class="var type0" id="S145T0U1617">qy</span> 2*<span class="var type0" id="S145T0U1622">qy</span>.*<span class="var type0" id="S146T0U1623">qz</span>+2*<span class="var type0" id="S142T0U1627">q0</span>.*<span class="var type0" id="S144T0U1628">qx</span> <span class="var type0" id="S142T0U1633">q0</span>.^2-<span class="var type0" id="S144T0U1636">qx</span>.^2-<span class="var type0" id="S145T0U1639">qy</span>.^2+<span class="var type0" id="S146T0U1642">qz</span>.^2];</span></span>
<span class="srcline"><span class="lineno"><a href="1,316" id="srcline316">316</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,317" id="srcline317">317</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,318" id="srcline318">318</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,319" id="srcline319">319</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,320" id="srcline320">320</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>

<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line">function [Tt, Tr, ER, t] = icp_mat(q,p)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% 输入变量，因为原版的是通过inputParser，这个在Matlab coder中不识别，所以这边略去这个部分，直接给输入变量赋值</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line">arg.Boundary = [];</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line">arg.EdgeRejection = false;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line">arg.Extrapolation = true;		<span class="comment">% false</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line">arg.iter = 15;					<span class="comment">% 迭代次数，默认10次</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line">arg.Matching = 'bruteForce';	<span class="comment">% 控制点匹配手法，注意这里只有暴力匹配能被Matlab Coder使用，其他手段都不能用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line">arg.Minimize = 'point';	</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line">arg.Normals = [];</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line">arg.p = p;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line">arg.q = q;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line">arg.ReturnAll = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line">arg.Triangulation = [];</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line">arg.Verbose = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line">arg.Weight = @(x)ones(1,length(x));</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line">arg.WorstRejection = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">% Actual implementation 实际应用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% Allocate vector for RMS of errors in every iteration.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% 这个t是结果用来统计均方根误差用的，这里完全可以不要，因为在Matlab Coder内不识别</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">% t = zeros(arg.iter+1,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">t = 0;							<span class="comment">% 只好这里放弃，在C里面再增加值进行测试</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">% Start timer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">% tic;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line">Np = size(p,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">% Transformed data point cloud</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">pt = p;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">% Allocate vector for RMS of errors in every iteration.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">ER = zeros(arg.iter+1,1); </span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">% Initialize temporary transform vector and matrix.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">T = zeros(3,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">R = eye(3,3);</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% Initialize total transform vector(s) and rotation matric(es).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">TT = zeros(3,1, arg.iter+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">TR = repmat(eye(3,3), [1,1, arg.iter+1]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line">Tt = zeros(3, 1);			<span class="comment">% 这两个变量是用于返回的，上面两个是过程变量</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line">Tr = zeros(3, 3);			<span class="comment">% 之所以这么做是因为Matlab在返回的时候会报Mismatch</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">% If edge vertices should be rejected, find edge vertices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">if arg.EdgeRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">    if isempty(arg.Boundary)</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">        bdr = find_bound(q, arg.Triangulation);</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    else</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">        bdr = arg.Boundary;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">if arg.Extrapolation</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">    <span class="comment">% Initialize total transform vector (quaternion ; translation vec.)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">    qq = [ones(1,arg.iter+1);zeros(6,arg.iter+1)];   </span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">    <span class="comment">% Allocate vector for direction change and change angle.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">    dq = zeros(7,arg.iter+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">    theta = zeros(1,arg.iter+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%t(1) = toc;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% Go into main iteration loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">for k=1:arg.iter</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">    <span class="comment">% Do matching</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">    switch arg.Matching</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">        case 'bruteForce'</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">            [match mindist] = match_bruteForce(q,pt);</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">%        case 'Delaunay'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">%            [match mindist] = match_Delaunay(q,pt,DT);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">%        case 'kDtree'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">%            [match mindist] = match_kDtree(q,pt,kdOBJ);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">	end</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">	<span class="comment">% If matches to edge vertices should be rejected</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    if arg.EdgeRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">        p_idx = not(ismember(match, bdr));</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">        q_idx = match(p_idx);</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">        mindist = mindist(p_idx);</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    else</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">        p_idx = true(1, Np);</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">        q_idx = match;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">    <span class="comment">% If worst matches should be rejected</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">    if arg.WorstRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">        edge = round((1-arg.WorstRejection)*sum(p_idx));</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">        pairs = find(p_idx);</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">        [~, idx] = sort(mindist);</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">        p_idx(pairs(idx(edge:end))) = false;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">        q_idx = match(p_idx);</span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">        mindist = mindist(p_idx);</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">	end</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">	if k == 1</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">        ER(k) = sqrt(sum(mindist.^2)/length(mindist));</span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">	end</span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">	switch arg.Minimize</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">        case 'point'</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">            <span class="comment">% Determine weight vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">            weights = arg.Weight(match);</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">            [R,T] = eq_point(q(:,q_idx),pt(:,p_idx), weights(p_idx));</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">%        case 'plane'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="comment">%            weights = arg.Weight(match);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">%            [R,T] = eq_plane(q(:,q_idx),pt(:,p_idx),arg.Normals(:,q_idx),weights(p_idx));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%        case 'lmaPoint'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="comment">%            [R,T] = eq_lmaPoint(q(:,q_idx),pt(:,p_idx));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">	end</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">    <span class="comment">% Add to the total transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">    TR(:,:,k+1) = R*TR(:,:,k);</span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">    TT(:,:,k+1) = R*TT(:,:,k)+T;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="comment">% Apply last transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    pt = TR(:,:,k+1) * p + repmat(TT(:,:,k+1), 1, Np);</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="comment">% Root mean of objective function </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    ER(k+1) = rms_error(q(:,q_idx), pt(:,p_idx));</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    <span class="comment">% If Extrapolation, we might be able to move quicker</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    if arg.Extrapolation</span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">        qq(:,k+1) = [rmat2quat(TR(:,:,k+1));TT(:,:,k+1)];</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">        dq(:,k+1) = qq(:,k+1) - qq(:,k);</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">        theta(k+1) = (180/pi)*acos(dot(dq(:,k),dq(:,k+1))/(norm(dq(:,k))*norm(dq(:,k+1))));</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">        if arg.Verbose</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">            disp(['Direction change ' num2str(theta(k+1)) ' degree in iteration ' num2str(k)]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">        if k&gt;2 &amp;&amp; theta(k+1) &lt; 10 &amp;&amp; theta(k) &lt; 10</span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">            d = [ER(k+1), ER(k), ER(k-1)];</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">            v = [0, -norm(dq(:,k+1)), -norm(dq(:,k))-norm(dq(:,k+1))];</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">            vmax = 25 * norm(dq(:,k+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">            dv = extrapolate(v,d,vmax);</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">            if dv ~= 0</span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">                q_mark = qq(:,k+1) + dv * dq(:,k+1)/norm(dq(:,k+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">                q_mark(1:4) = q_mark(1:4)/norm(q_mark(1:4));</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">                qq(:,k+1) = q_mark;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">                TR(:,:,k+1) = quat2rmat(qq(1:4,k+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">                TT(:,:,k+1) = qq(5:7,k+1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">                <span class="comment">% Reapply total transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">                pt = TR(:,:,k+1) * p + repmat(TT(:,:,k+1), 1, Np);</span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">                <span class="comment">% Recalculate root mean of objective function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">                <span class="comment">% Note this is costly and only for fun!</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">                switch arg.Matching</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">                    case 'bruteForce'</span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">                        [~, mindist] = match_bruteForce(q,pt);</span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="comment">%                    case 'Delaunay'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="comment">%                        [~, mindist] = match_Delaunay(q,pt,DT);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="comment">%                    case 'kDtree'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"><span class="comment">%                        [~, mindist] = match_kDtree(q,pt,kdOBJ);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">                end</span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">                ER(k+1) = sqrt(sum(mindist.^2)/length(mindist));</span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">            end</span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">    <span class="comment">% t(k+1) = toc;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">Tr = TR(:,:,end);</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line">Tt = TT(:,:,end);</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"><span class="comment">%if not(arg.ReturnAll)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"><span class="comment">%	% 原来这样在Matlab Coder里会报Mismatch，这边只好加入一个临时变量，用于返回</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"><span class="comment">%   % 这段也弃用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"><span class="comment">%    TR = TR(:,:,end);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="comment">%    TT = TT(:,:,end);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"><span class="comment">% 暴力匹配</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">function [match mindist] = match_bruteForce(q, p)</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">    m = size(p,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">    n = size(q,2);    </span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">    match = zeros(1,m);</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">    mindist = zeros(1,m);</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">    for ki=1:m</span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">        d=zeros(1,n);</span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">        for ti=1:3</span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">            d=d+(q(ti,:)-p(ti,ki)).^2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">        [mindist(ki),match(ki)]=min(d);</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    mindist = sqrt(mindist);</span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">function [R,T] = eq_point(q,p,weights)</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">m = size(p,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">n = size(q,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="comment">% normalize weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">weights = weights ./ sum(weights);</span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"><span class="comment">% find data centroid and deviations from centroid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">q_bar = q * transpose(weights);</span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">q_mark = q - repmat(q_bar, 1, n);</span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line"><span class="comment">% Apply weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">q_mark = q_mark .* repmat(weights, 3, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line"><span class="comment">% find data centroid and deviations from centroid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line">p_bar = p * transpose(weights);</span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line">p_mark = p - repmat(p_bar, 1, m);</span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"><span class="comment">% Apply weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"><span class="comment">%p_mark = p_mark .* repmat(weights, 3, 1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line">N = p_mark*transpose(q_mark); <span class="comment">% taking points of q in matched order</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line">[U,~,V] = svd(N); <span class="comment">% singular value decomposition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line">R = V*diag([1 1 det(U*V')])*transpose(U);</span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line">T = q_bar - R*p_bar;</span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line"><span class="comment">% Extrapolation in quaternion space. Details are found in:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line"><span class="comment">% Besl, P., &amp; McKay, N. (1992). A method for registration of 3-D shapes. </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line"><span class="comment">% IEEE Transactions on pattern analysis and machine intelligence, 239?256.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line">function [dv] = extrapolate(v,d,vmax)</span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line">p1 = polyfit(v,d,1); <span class="comment">% linear fit</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line">p2 = polyfit(v,d,2); <span class="comment">% parabolic fit</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line">v1 = -p1(2)/p1(1); <span class="comment">% linear zero crossing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line">v2 = -p2(2)/(2*p2(1)); <span class="comment">% polynomial top point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line">if issorted([0 v2 v1 vmax]) || issorted([0 v2 vmax v1])</span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line">    disp('Parabolic update!');</span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line">    dv = v2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line">elseif issorted([0 v1 v2 vmax]) || issorted([0 v1 vmax v2])...</span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line">        || (v2 &lt; 0 &amp;&amp; issorted([0 v1 vmax]))</span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line">    disp('Line based update!');</span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line">    dv = v1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line">elseif v1 &gt; vmax &amp;&amp; v2 &gt; vmax</span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line">    disp('Maximum update!');</span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line">    dv = vmax;</span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line">else</span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line">    disp('No extrapolation!');</span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line">    dv = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,252" id="srcline252">252</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,253" id="srcline253">253</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,254" id="srcline254">254</a></span><span class="line"><span class="comment">% Determine the RMS error between two point equally sized point clouds with</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,255" id="srcline255">255</a></span><span class="line"><span class="comment">% point correspondance.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,256" id="srcline256">256</a></span><span class="line"><span class="comment">% ER = rms_error(p1,p2) where p1 and p2 are 3xn matrices.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,257" id="srcline257">257</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,258" id="srcline258">258</a></span><span class="line">function ER = rms_error(p1,p2)</span></span>
<span class="srcline"><span class="lineno"><a href="1,259" id="srcline259">259</a></span><span class="line">dsq = sum(power(p1 - p2, 2),1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,260" id="srcline260">260</a></span><span class="line">ER = sqrt(mean(dsq));</span></span>
</pre>
</div>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,261" id="srcline261">261</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,262" id="srcline262">262</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,263" id="srcline263">263</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,264" id="srcline264">264</a></span><span class="line"><span class="comment">% Converts (orthogonal) rotation matrices R to (unit) quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,265" id="srcline265">265</a></span><span class="line"><span class="comment">% representations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,266" id="srcline266">266</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,267" id="srcline267">267</a></span><span class="line"><span class="comment">% Input: A 3x3xn matrix of rotation matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,268" id="srcline268">268</a></span><span class="line"><span class="comment">% Output: A 4xn matrix of n corresponding quaternions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,269" id="srcline269">269</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,270" id="srcline270">270</a></span><span class="line"><span class="comment">% http://en.wikipedia.org/wiki/Rotation_matrix#Quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,271" id="srcline271">271</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,272" id="srcline272">272</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S121T24U1277">quaternion</span> = rmat2quat(<span class="var type1" id="S122T2U1280">R</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,273" id="srcline273">273</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,274" id="srcline274">274</a></span><span class="line"><span class="mxinfo " id="T4:U3"><span class="var type1" id="S123T4U1283">Qxx</span> = <span class="mxinfo " id="T4:U5"><span class="var type1" id="S122T2U1285">R</span>(<span class="mxinfo " id="T21:U7">1</span>,<span class="mxinfo " id="T21:U8">1</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,275" id="srcline275">275</a></span><span class="line"><span class="mxinfo " id="T4:U9"><span class="var type1" id="S124T4U1291">Qxy</span> = <span class="mxinfo " id="T4:U11"><span class="var type1" id="S122T2U1293">R</span>(<span class="mxinfo " id="T4:U13">1</span>,<span class="mxinfo " id="T4:U14">2</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,276" id="srcline276">276</a></span><span class="line"><span class="mxinfo " id="T4:U15"><span class="var type1" id="S125T4U1299">Qxz</span> = <span class="mxinfo " id="T4:U17"><span class="var type1" id="S122T2U1301">R</span>(<span class="mxinfo " id="T21:U19">1</span>,<span class="mxinfo " id="T21:U20">3</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,277" id="srcline277">277</a></span><span class="line"><span class="mxinfo " id="T4:U21"><span class="var type1" id="S126T4U1307">Qyx</span> = <span class="mxinfo " id="T4:U23"><span class="var type1" id="S122T2U1309">R</span>(<span class="mxinfo " id="T21:U25">2</span>,<span class="mxinfo " id="T21:U26">1</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line"><span class="mxinfo " id="T4:U27"><span class="var type1" id="S127T4U1315">Qyy</span> = <span class="mxinfo " id="T4:U29"><span class="var type1" id="S122T2U1317">R</span>(<span class="mxinfo " id="T4:U31">2</span>,<span class="mxinfo " id="T4:U32">2</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line"><span class="mxinfo " id="T4:U33"><span class="var type1" id="S128T4U1323">Qyz</span> = <span class="mxinfo " id="T4:U35"><span class="var type1" id="S122T2U1325">R</span>(<span class="mxinfo " id="T4:U37">2</span>,<span class="mxinfo " id="T4:U38">3</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line"><span class="mxinfo " id="T4:U39"><span class="var type1" id="S129T4U1331">Qzx</span> = <span class="mxinfo " id="T4:U41"><span class="var type1" id="S122T2U1333">R</span>(<span class="mxinfo " id="T4:U43">3</span>,<span class="mxinfo " id="T4:U44">1</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line"><span class="mxinfo " id="T4:U45"><span class="var type1" id="S130T4U1339">Qzy</span> = <span class="mxinfo " id="T4:U47"><span class="var type1" id="S122T2U1341">R</span>(<span class="mxinfo " id="T21:U49">3</span>,<span class="mxinfo " id="T21:U50">2</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line"><span class="mxinfo " id="T4:U51"><span class="var type1" id="S131T4U1347">Qzz</span> = <span class="mxinfo " id="T4:U53"><span class="var type1" id="S122T2U1349">R</span>(<span class="mxinfo " id="T4:U55">3</span>,<span class="mxinfo " id="T4:U56">3</span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line"><span class="mxinfo " id="T4:U57"><span class="var type1" id="S132T4U1355">w</span> = <span class="mxinfo " id="T4:U59"><span class="mxinfo " id="T4:U60">0.5</span> * <span class="mxinfo " id="T4:U61"><span class="potentialdiff PD1">sqrt(<span class="mxinfo " id="T4:U62"><span class="mxinfo " id="T4:U63"><span class="mxinfo " id="T4:U64"><span class="mxinfo " id="T4:U65">1</span>+<span class="var type1" id="S123T4U1364">Qxx</span></span>+<span class="var type1" id="S127T4U1365">Qyy</span></span>+<span class="var type1" id="S131T4U1366">Qzz</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line"><span class="mxinfo " id="T4:U69"><span class="var type1" id="S134T4U1369">x</span> = <span class="mxinfo " id="T4:U71"><span class="mxinfo " id="T4:U72"><span class="mxinfo " id="T4:U73">0.5</span> * <span class="mxinfo " id="T4:U74">sign(<span class="mxinfo " id="T4:U75"><span class="var type1" id="S130T4U1376">Qzy</span>-<span class="var type1" id="S128T4U1377">Qyz</span></span>)</span></span> .* <span class="mxinfo " id="T4:U78"><span class="potentialdiff PD1">sqrt(<span class="mxinfo " id="T4:U79"><span class="mxinfo " id="T4:U80"><span class="mxinfo " id="T4:U81"><span class="mxinfo " id="T4:U82">1</span>+<span class="var type1" id="S123T4U1384">Qxx</span></span>-<span class="var type1" id="S127T4U1385">Qyy</span></span>-<span class="var type1" id="S131T4U1386">Qzz</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line"><span class="mxinfo " id="T4:U86"><span class="var type1" id="S136T4U1389">y</span> = <span class="mxinfo " id="T4:U88"><span class="mxinfo " id="T4:U89"><span class="mxinfo " id="T4:U90">0.5</span> * <span class="mxinfo " id="T4:U91">sign(<span class="mxinfo " id="T4:U92"><span class="var type1" id="S125T4U1396">Qxz</span>-<span class="var type1" id="S129T4U1397">Qzx</span></span>)</span></span> .* <span class="mxinfo " id="T4:U95"><span class="potentialdiff PD1">sqrt(<span class="mxinfo " id="T4:U96"><span class="mxinfo " id="T4:U97"><span class="mxinfo " id="T4:U98"><span class="mxinfo " id="T4:U99">1</span>-<span class="var type1" id="S123T4U1404">Qxx</span></span>+<span class="var type1" id="S127T4U1405">Qyy</span></span>-<span class="var type1" id="S131T4U1406">Qzz</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line"><span class="mxinfo " id="T4:U103"><span class="var type1" id="S137T4U1409">z</span> = <span class="mxinfo " id="T4:U105"><span class="mxinfo " id="T4:U106"><span class="mxinfo " id="T4:U107">0.5</span> * <span class="mxinfo " id="T4:U108">sign(<span class="mxinfo " id="T4:U109"><span class="var type1" id="S126T4U1416">Qyx</span>-<span class="var type1" id="S124T4U1417">Qxy</span></span>)</span></span> .* <span class="mxinfo " id="T4:U112"><span class="potentialdiff PD1">sqrt(<span class="mxinfo " id="T4:U113"><span class="mxinfo " id="T4:U114"><span class="mxinfo " id="T4:U115"><span class="mxinfo " id="T4:U116">1</span>-<span class="var type1" id="S123T4U1424">Qxx</span></span>-<span class="var type1" id="S127T4U1425">Qyy</span></span>+<span class="var type1" id="S131T4U1426">Qzz</span></span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line"><span class="mxinfo " id="T24:U120"><span class="var type1" id="S121T24U1429">quaternion</span> = <span class="mxinfo " id="T24:U122">reshape(<span class="mxinfo " id="T24:U123">[<span class="var type1" id="S132T4U1434">w</span>;<span class="var type1" id="S134T4U1436">x</span>;<span class="var type1" id="S136T4U1438">y</span>;<span class="var type1" id="S137T4U1440">z</span>]</span>,4,[])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line"><span class="comment">% Converts (unit) quaternion representations to (orthogonal) rotation matrices R</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line"><span class="comment">% Input: A 4xn matrix of n quaternions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line"><span class="comment">% Output: A 3x3xn matrix of corresponding rotation matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,297" id="srcline297">297</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,298" id="srcline298">298</a></span><span class="line"><span class="comment">% http://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation#From_a_quaternion_to_an_orthogonal_matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,299" id="srcline299">299</a></span><span class="line"></span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,300" id="srcline300">300</a></span><span class="line">function R = quat2rmat(quaternion)</span></span>
<span class="srcline"><span class="lineno"><a href="1,301" id="srcline301">301</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,302" id="srcline302">302</a></span><span class="line"><span class="comment">% 这里增加一个初始化，这边敢这么设置是因为这个东西本身就是二维的</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,303" id="srcline303">303</a></span><span class="line">q0 = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,304" id="srcline304">304</a></span><span class="line">qx = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,305" id="srcline305">305</a></span><span class="line">qy = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,306" id="srcline306">306</a></span><span class="line">qz = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,307" id="srcline307">307</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,308" id="srcline308">308</a></span><span class="line">q0(1,1,:) = quaternion(1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,309" id="srcline309">309</a></span><span class="line">qx(1,1,:) = quaternion(2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,310" id="srcline310">310</a></span><span class="line">qy(1,1,:) = quaternion(3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,311" id="srcline311">311</a></span><span class="line">qz(1,1,:) = quaternion(4,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,312" id="srcline312">312</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,313" id="srcline313">313</a></span><span class="line">R = [q0.^2+qx.^2-qy.^2-qz.^2 2*qx.*qy-2*q0.*qz 2*qx.*qz+2*q0.*qy;</span></span>
<span class="srcline"><span class="lineno"><a href="1,314" id="srcline314">314</a></span><span class="line">     2*qx.*qy+2*q0.*qz q0.^2-qx.^2+qy.^2-qz.^2 2*qy.*qz-2*q0.*qx;</span></span>
<span class="srcline"><span class="lineno"><a href="1,315" id="srcline315">315</a></span><span class="line">     2*qx.*qz-2*q0.*qy 2*qy.*qz+2*q0.*qx q0.^2-qx.^2-qy.^2+qz.^2];</span></span>
<span class="srcline"><span class="lineno"><a href="1,316" id="srcline316">316</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,317" id="srcline317">317</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,318" id="srcline318">318</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,319" id="srcline319">319</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,320" id="srcline320">320</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>

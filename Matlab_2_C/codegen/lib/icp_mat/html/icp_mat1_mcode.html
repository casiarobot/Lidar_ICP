<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">Tt</span>, <span class="var type1" id="S3T2U4">Tr</span>, <span class="var type1" id="S4T3U5">ER</span>, <span class="var type1" id="S5T4U6">t</span>] = icp_mat(<span class="var type1" id="S6T5U9">q</span>,<span class="var type1" id="S7T5U10">p</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% 输入变量，因为原版的是通过inputParser，这个在Matlab coder中不识别，所以这边略去这个部分，直接给输入变量赋值</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="mxinfo " id="T6:U7"><span class="mxinfo " id="T6:U8"><span class="var type1" id="S8T7U14">arg</span>.Boundary</span> = <span class="mxinfo " id="T6:U10">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="mxinfo " id="T8:U11"><span class="mxinfo " id="T8:U12"><span class="var type1" id="S8T7U21">arg</span>.EdgeRejection</span> = <span class="mxinfo " id="T8:U14">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="mxinfo " id="T8:U15"><span class="mxinfo " id="T8:U16"><span class="var type1" id="S8T7U28">arg</span>.Extrapolation</span> = <span class="mxinfo " id="T8:U18">true</span></span>;		<span class="comment">% false</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="mxinfo " id="T4:U19"><span class="mxinfo " id="T4:U20"><span class="var type1" id="S8T7U35">arg</span>.iter</span> = <span class="mxinfo " id="T4:U22">15</span></span>;					<span class="comment">% 迭代次数，默认10次</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="mxinfo " id="T9:U23"><span class="mxinfo " id="T9:U24"><span class="var type1" id="S8T7U41">arg</span>.Matching</span> = <span class="mxinfo " id="T9:U26"><span class="string">'bruteForce'</span></span></span>;	<span class="comment">% 控制点匹配手法，注意这里只有暴力匹配能被Matlab Coder使用，其他手段都不能用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="mxinfo " id="T10:U27"><span class="mxinfo " id="T10:U28"><span class="var type1" id="S8T7U47">arg</span>.Minimize</span> = <span class="mxinfo " id="T10:U30"><span class="string">'point'</span></span></span>;	</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="mxinfo " id="T6:U31"><span class="mxinfo " id="T6:U32"><span class="var type1" id="S8T7U53">arg</span>.Normals</span> = <span class="mxinfo " id="T6:U34">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="mxinfo " id="T5:U35"><span class="mxinfo " id="T5:U36"><span class="var type1" id="S8T7U60">arg</span>.p</span> = <span class="var type1" id="S7T5U62">p</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="mxinfo " id="T5:U39"><span class="mxinfo " id="T5:U40"><span class="var type1" id="S8T7U66">arg</span>.q</span> = <span class="var type1" id="S6T5U68">q</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="mxinfo " id="T4:U43"><span class="mxinfo " id="T4:U44"><span class="var type1" id="S8T7U72">arg</span>.ReturnAll</span> = <span class="mxinfo " id="T4:U46">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="mxinfo " id="T6:U47"><span class="mxinfo " id="T6:U48"><span class="var type1" id="S8T7U78">arg</span>.Triangulation</span> = <span class="mxinfo " id="T6:U50">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="mxinfo " id="T4:U51"><span class="mxinfo " id="T4:U52"><span class="var type1" id="S8T7U85">arg</span>.Verbose</span> = <span class="mxinfo " id="T4:U54">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo " id="T11:U55"><span class="mxinfo " id="T11:U56"><span class="var type1" id="S8T7U91">arg</span>.Weight</span> = <span class="mxinfo " id="T11:U58">@(x)ones(1,length(x))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo " id="T4:U59"><span class="mxinfo " id="T4:U60"><span class="var type1" id="S8T7U104">arg</span>.WorstRejection</span> = <span class="mxinfo " id="T4:U62">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="comment">% Actual implementation 实际应用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% Allocate vector for RMS of errors in every iteration.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">% 这个t是结果用来统计均方根误差用的，这里完全可以不要，因为在Matlab Coder内不识别</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">% t = zeros(arg.iter+1,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="mxinfo " id="T4:U63"><span class="var type1" id="S5T4U109">t</span> = <span class="mxinfo " id="T4:U65">0</span></span>;							<span class="comment">% 只好这里放弃，在C里面再增加值进行测试</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">% Start timer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">% tic;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="mxinfo " id="T4:U66"><span class="var type1" id="S13T4U113">Np</span> = <span class="mxinfo " id="T4:U68">size(<span class="var type1" id="S7T5U116">p</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="comment">% Transformed data point cloud</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo " id="T5:U70"><span class="var type1" id="S15T5U120">pt</span> = <span class="var type1" id="S7T5U121">p</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">% Allocate vector for RMS of errors in every iteration.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T3:U73"><span class="var type1" id="S4T3U124">ER</span> = <span class="mxinfo " id="T3:U75">zeros(<span class="mxinfo " id="T4:U76"><span class="var type1" id="S8T7U129">arg</span>.iter+1</span>,1)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">% Initialize temporary transform vector and matrix.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="mxinfo " id="T1:U78"><span class="var type1" id="S17T1U135">T</span> = <span class="mxinfo " id="T1:U80">zeros(<span class="mxinfo " id="T4:U81">3</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="mxinfo " id="T2:U82"><span class="var type1" id="S18T2U142">R</span> = <span class="mxinfo " id="T2:U84">eye(3,3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% Initialize total transform vector(s) and rotation matric(es).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="mxinfo " id="T12:U85"><span class="var type1" id="S20T12U149">TT</span> = <span class="mxinfo " id="T12:U87">zeros(<span class="mxinfo " id="T4:U88">3</span>,<span class="mxinfo " id="T4:U89">1</span>, <span class="mxinfo " id="T4:U90"><span class="var type1" id="S8T7U156">arg</span>.iter+1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="mxinfo " id="T13:U92"><span class="var type1" id="S21T13U161">TR</span> = <span class="mxinfo " id="T13:U94">repmat(eye(3,3), [1,1, <span class="var type1" id="S8T7U174">arg</span>.iter+1])</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="mxinfo " id="T1:U96"><span class="var type1" id="S2T1U179">Tt</span> = <span class="mxinfo " id="T1:U98">zeros(<span class="mxinfo " id="T4:U99">3</span>, 1)</span></span>;			<span class="comment">% 这两个变量是用于返回的，上面两个是过程变量</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="mxinfo " id="T2:U100"><span class="var type1" id="S3T2U186">Tr</span> = <span class="mxinfo " id="T2:U102">zeros(<span class="mxinfo " id="T4:U103">3</span>, <span class="mxinfo " id="T4:U104">3</span>)</span></span>;			<span class="comment">% 之所以这么做是因为Matlab在返回的时候会报Mismatch</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="comment">% If edge vertices should be rejected, find edge vertices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S8T7U194">arg</span>.EdgeRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">    <span class="keyword">if</span> isempty(<span class="var type0" id="S8T0U201">arg</span>.Boundary)</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">        <span class="var type0" id="S24T0U205">bdr</span> = find_bound(<span class="var type0" id="S6T0U208">q</span>, <span class="var type0" id="S8T0U210">arg</span>.Triangulation);</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">        <span class="var type0" id="S24T0U215">bdr</span> = <span class="var type0" id="S8T0U217">arg</span>.Boundary;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S8T7U222">arg</span>.Extrapolation</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">    <span class="comment">% Initialize total transform vector (quaternion ; translation vec.)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">    <span class="mxinfo " id="T14:U107"><span class="var type1" id="S26T14U226">qq</span> = <span class="mxinfo " id="T14:U109">[<span class="mxinfo " id="T15:U110">ones(<span class="mxinfo " id="T4:U111">1</span>,<span class="mxinfo " id="T4:U112"><span class="var type1" id="S8T7U234">arg</span>.iter+1</span>)</span>;<span class="mxinfo " id="T16:U114">zeros(<span class="mxinfo " id="T4:U115">6</span>,<span class="mxinfo " id="T4:U116"><span class="var type1" id="S8T7U243">arg</span>.iter+1</span>)</span>]</span></span>;   </span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">    <span class="comment">% Allocate vector for direction change and change angle.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">    <span class="mxinfo " id="T14:U118"><span class="var type1" id="S27T14U248">dq</span> = <span class="mxinfo " id="T14:U120">zeros(<span class="mxinfo " id="T4:U121">7</span>,<span class="mxinfo " id="T4:U122"><span class="var type1" id="S8T7U254">arg</span>.iter+1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">    <span class="mxinfo " id="T15:U124"><span class="var type1" id="S28T15U259">theta</span> = <span class="mxinfo " id="T15:U126">zeros(<span class="mxinfo " id="T4:U127">1</span>,<span class="mxinfo " id="T4:U128"><span class="var type1" id="S8T7U265">arg</span>.iter+1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">%t(1) = toc;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% Go into main iteration loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S29T4U270">k</span>=<span class="mxinfo " id="T4:U131">1</span>:<span class="var type1" id="S8T7U274">arg</span>.iter</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">    <span class="comment">% Do matching</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">    <span class="keyword">switch</span> <span class="var type1" id="S8T7U278">arg</span>.Matching</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">        <span class="keyword">case</span> <span class="string">'bruteForce'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">            [<span class="var type1" id="S30T17U285">match</span> <span class="var type1" id="S31T17U286">mindist</span>] = <span class="fcn" id="F121N10:B288">match_bruteForce</span>(<span class="var type1" id="S6T5U289">q</span>,<span class="var type1" id="S15T5U290">pt</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line"><span class="comment">%        case 'Delaunay'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="comment">%            [match mindist] = match_Delaunay(q,pt,DT);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">%        case 'kDtree'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line"><span class="comment">%            [match mindist] = match_kDtree(q,pt,kdOBJ);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">	<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">	<span class="comment">% If matches to edge vertices should be rejected</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S8T7U294">arg</span>.EdgeRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">        <span class="var type0" id="S33T0U298">p_idx</span> = not(ismember(<span class="var type0" id="S30T0U303">match</span>, <span class="var type0" id="S24T0U304">bdr</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">        <span class="var type0" id="S36T0U307">q_idx</span> = <span class="var type0" id="S30T0U309">match</span>(<span class="var type0" id="S33T0U310">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">        <span class="var type0" id="S31T0U313">mindist</span> = <span class="var type0" id="S31T0U315">mindist</span>(<span class="var type0" id="S33T0U316">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">        <span class="mxinfo " id="T18:U139"><span class="var type1" id="S33T18U320">p_idx</span> = <span class="mxinfo " id="T18:U141">true(<span class="mxinfo " id="T4:U142">1</span>, <span class="var type1" id="S13T4U324">Np</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">        <span class="mxinfo " id="T17:U144"><span class="var type1" id="S36T17U327">q_idx</span> = <span class="var type1" id="S30T17U328">match</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">    <span class="comment">% If worst matches should be rejected</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S8T7U332">arg</span>.WorstRejection</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">        <span class="var type0" id="S37T0U336">edge</span> = round((1-<span class="var type0" id="S8T0U344">arg</span>.WorstRejection)*sum(<span class="var type0" id="S33T0U348">p_idx</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">        <span class="var type0" id="S40T0U351">pairs</span> = find(<span class="var type0" id="S33T0U354">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">        [~, <span class="var type0" id="S42T0U359">idx</span>] = sort(<span class="var type0" id="S31T0U362">mindist</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">        <span class="var type0" id="S33T0U366">p_idx</span>(<span class="var type0" id="S40T0U368">pairs</span>(<span class="var type0" id="S42T0U370">idx</span>(<span class="var type0" id="S37T0U372">edge</span>:end))) = false;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">        <span class="var type0" id="S36T0U379">q_idx</span> = <span class="var type0" id="S30T0U381">match</span>(<span class="var type0" id="S33T0U382">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">        <span class="var type0" id="S31T0U385">mindist</span> = <span class="var type0" id="S31T0U387">mindist</span>(<span class="var type0" id="S33T0U388">p_idx</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">	<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">	<span class="keyword">if</span> <span class="mxinfo " id="T8:U148"><span class="var type1" id="S29T4U392">k</span> == <span class="mxinfo " id="T4:U150">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">        <span class="mxinfo " id="T4:U151"><span class="mxinfo " id="T4:U152"><span class="var type1" id="S4T3U397">ER</span>(<span class="var type1" id="S29T4U398">k</span>)</span> = <span class="mxinfo " id="T4:U155">sqrt(<span class="mxinfo " id="T4:U156"><span class="mxinfo " id="T4:U157">sum(<span class="mxinfo " id="T17:U158"><span class="var type1" id="S31T17U405">mindist</span>.^2</span>)</span>/<span class="mxinfo " id="T4:U160">length(<span class="var type1" id="S31T17U409">mindist</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">	<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">	<span class="keyword">switch</span> <span class="var type1" id="S8T7U412">arg</span>.Minimize</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">        <span class="keyword">case</span> <span class="string">'point'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">            <span class="comment">% Determine weight vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">            <span class="mxinfo " id="T17:U163"><span class="var type1" id="S46T17U418">weights</span> = <span class="mxinfo " id="T17:U165"><span class="var type1" id="S8T7U421">arg</span>.<span class="fcn" id="F157N7:B422">Weight</span>(<span class="var type1" id="S30T17U423">match</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">            [<span class="var type1" id="S18T2U427">R</span>,<span class="var type1" id="S17T1U428">T</span>] = <span class="fcn" id="F414N8:B430">eq_point</span>(<span class="mxinfo " id="T5:U170"><span class="var type1" id="S6T5U432">q</span>(<span class="mxinfo " id="T19:U172">:</span>,<span class="var type1" id="S36T17U434">q_idx</span>)</span>,<span class="mxinfo " id="T5:U174"><span class="var type1" id="S15T5U436">pt</span>(<span class="mxinfo " id="T19:U176">:</span>,<span class="var type1" id="S33T18U438">p_idx</span>)</span>, <span class="mxinfo " id="T17:U178"><span class="var type1" id="S46T17U440">weights</span>(<span class="var type1" id="S33T18U441">p_idx</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="comment">%        case 'plane'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="comment">%            weights = arg.Weight(match);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">%            [R,T] = eq_plane(q(:,q_idx),pt(:,p_idx),arg.Normals(:,q_idx),weights(p_idx));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%        case 'lmaPoint'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="comment">%            [R,T] = eq_lmaPoint(q(:,q_idx),pt(:,p_idx));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">	<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">    <span class="comment">% Add to the total transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">    <span class="mxinfo " id="T2:U181"><span class="mxinfo " id="T2:U182"><span class="var type1" id="S21T13U445">TR</span>(<span class="mxinfo " id="T19:U184">:</span>,<span class="mxinfo " id="T19:U185">:</span>,<span class="mxinfo " id="T4:U186"><span class="var type1" id="S29T4U449">k</span>+<span class="mxinfo " id="T4:U188">1</span></span>)</span> = <span class="mxinfo " id="T2:U189"><span class="var type1" id="S18T2U452">R</span>*<span class="mxinfo " id="T2:U191"><span class="var type1" id="S21T13U454">TR</span>(<span class="mxinfo " id="T19:U193">:</span>,<span class="mxinfo " id="T19:U194">:</span>,<span class="var type1" id="S29T4U457">k</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line">    <span class="mxinfo " id="T1:U196"><span class="mxinfo " id="T1:U197"><span class="var type1" id="S20T12U461">TT</span>(<span class="mxinfo " id="T19:U199">:</span>,<span class="mxinfo " id="T20:U200">:</span>,<span class="mxinfo " id="T4:U201"><span class="var type1" id="S29T4U465">k</span>+<span class="mxinfo " id="T4:U203">1</span></span>)</span> = <span class="mxinfo " id="T1:U204"><span class="mxinfo " id="T1:U205"><span class="var type1" id="S18T2U469">R</span>*<span class="mxinfo " id="T1:U207"><span class="var type1" id="S20T12U471">TT</span>(<span class="mxinfo " id="T19:U209">:</span>,<span class="mxinfo " id="T20:U210">:</span>,<span class="var type1" id="S29T4U474">k</span>)</span></span>+<span class="var type1" id="S17T1U475">T</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">    <span class="comment">% Apply last transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line">    <span class="mxinfo " id="T5:U213"><span class="var type1" id="S15T5U478">pt</span> = <span class="mxinfo " id="T5:U215"><span class="mxinfo " id="T5:U216"><span class="mxinfo " id="T2:U217"><span class="var type1" id="S21T13U482">TR</span>(<span class="mxinfo " id="T19:U219">:</span>,<span class="mxinfo " id="T19:U220">:</span>,<span class="mxinfo " id="T4:U221"><span class="var type1" id="S29T4U486">k</span>+<span class="mxinfo " id="T4:U223">1</span></span>)</span> * <span class="var type1" id="S7T5U488">p</span></span> + <span class="mxinfo " id="T5:U225">repmat(<span class="mxinfo " id="T1:U226"><span class="var type1" id="S20T12U492">TT</span>(<span class="mxinfo " id="T19:U228">:</span>,<span class="mxinfo " id="T20:U229">:</span>,<span class="mxinfo " id="T4:U230"><span class="var type1" id="S29T4U496">k</span>+<span class="mxinfo " id="T4:U232">1</span></span>)</span>, 1, <span class="var type1" id="S13T4U499">Np</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">    <span class="comment">% Root mean of objective function </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">    <span class="mxinfo " id="T4:U234"><span class="mxinfo " id="T4:U235"><span class="var type1" id="S4T3U503">ER</span>(<span class="mxinfo " id="T4:U237"><span class="var type1" id="S29T4U505">k</span>+<span class="mxinfo " id="T4:U239">1</span></span>)</span> = <span class="mxinfo " id="T4:U240"><span class="fcn" id="F457N13:B508">rms_error</span>(<span class="mxinfo " id="T5:U241"><span class="var type1" id="S6T5U510">q</span>(<span class="mxinfo " id="T19:U243">:</span>,<span class="var type1" id="S36T17U512">q_idx</span>)</span>, <span class="mxinfo " id="T5:U245"><span class="var type1" id="S15T5U514">pt</span>(<span class="mxinfo " id="T19:U247">:</span>,<span class="var type1" id="S33T18U516">p_idx</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    <span class="comment">% If Extrapolation, we might be able to move quicker</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    <span class="keyword">if</span> <span class="var type1" id="S8T7U520">arg</span>.Extrapolation</span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">        <span class="mxinfo " id="T21:U250"><span class="mxinfo " id="T21:U251"><span class="var type1" id="S26T14U525">qq</span>(<span class="mxinfo " id="T22:U253">:</span>,<span class="mxinfo " id="T4:U254"><span class="var type1" id="S29T4U528">k</span>+<span class="mxinfo " id="T4:U256">1</span></span>)</span> = <span class="mxinfo " id="T21:U257">[<span class="mxinfo " id="T23:U258">rmat2quat(<span class="mxinfo " id="T2:U259"><span class="var type1" id="S21T13U535">TR</span>(<span class="mxinfo " id="T19:U261">:</span>,<span class="mxinfo " id="T19:U262">:</span>,<span class="mxinfo " id="T4:U263"><span class="var type1" id="S29T4U539">k</span>+<span class="mxinfo " id="T4:U265">1</span></span>)</span>)</span>;<span class="mxinfo " id="T1:U266"><span class="var type1" id="S20T12U543">TT</span>(<span class="mxinfo " id="T19:U268">:</span>,<span class="mxinfo " id="T20:U269">:</span>,<span class="mxinfo " id="T4:U270"><span class="var type1" id="S29T4U547">k</span>+<span class="mxinfo " id="T4:U272">1</span></span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">        <span class="mxinfo " id="T21:U273"><span class="mxinfo " id="T21:U274"><span class="var type1" id="S27T14U552">dq</span>(<span class="mxinfo " id="T22:U276">:</span>,<span class="mxinfo " id="T4:U277"><span class="var type1" id="S29T4U555">k</span>+<span class="mxinfo " id="T4:U279">1</span></span>)</span> = <span class="mxinfo " id="T21:U280"><span class="mxinfo " id="T21:U281"><span class="var type1" id="S26T14U559">qq</span>(<span class="mxinfo " id="T22:U283">:</span>,<span class="mxinfo " id="T4:U284"><span class="var type1" id="S29T4U562">k</span>+<span class="mxinfo " id="T4:U286">1</span></span>)</span> - <span class="mxinfo " id="T21:U287"><span class="var type1" id="S26T14U565">qq</span>(<span class="mxinfo " id="T22:U289">:</span>,<span class="var type1" id="S29T4U567">k</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">        <span class="mxinfo " id="T4:U291"><span class="mxinfo " id="T4:U292"><span class="var type1" id="S28T15U571">theta</span>(<span class="mxinfo " id="T4:U294"><span class="var type1" id="S29T4U573">k</span>+<span class="mxinfo " id="T4:U296">1</span></span>)</span> = <span class="mxinfo " id="T4:U297">(<span class="mxinfo " id="T4:U298"><span class="mxinfo " id="T4:U299">180</span>/<span class="mxinfo " id="T4:U300">pi</span></span>)*<span class="mxinfo " id="T4:U301">acos(<span class="mxinfo " id="T4:U302"><span class="mxinfo " id="T4:U303">dot(<span class="mxinfo " id="T21:U304"><span class="var type1" id="S27T14U587">dq</span>(<span class="mxinfo " id="T22:U306">:</span>,<span class="var type1" id="S29T4U589">k</span>)</span>,<span class="mxinfo " id="T21:U308"><span class="var type1" id="S27T14U591">dq</span>(<span class="mxinfo " id="T22:U310">:</span>,<span class="mxinfo " id="T4:U311"><span class="var type1" id="S29T4U594">k</span>+<span class="mxinfo " id="T4:U313">1</span></span>)</span>)</span>/(<span class="mxinfo " id="T4:U314"><span class="mxinfo " id="T4:U315">norm(<span class="mxinfo " id="T21:U316"><span class="var type1" id="S27T14U601">dq</span>(<span class="mxinfo " id="T22:U318">:</span>,<span class="var type1" id="S29T4U603">k</span>)</span>)</span>*<span class="mxinfo " id="T4:U320">norm(<span class="mxinfo " id="T21:U321"><span class="var type1" id="S27T14U607">dq</span>(<span class="mxinfo " id="T22:U323">:</span>,<span class="mxinfo " id="T4:U324"><span class="var type1" id="S29T4U610">k</span>+<span class="mxinfo " id="T4:U326">1</span></span>)</span>)</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S8T7U615">arg</span>.Verbose</span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">            disp([<span class="string">'Direction change '</span> num2str(<span class="var type0" id="S28T0U626">theta</span>(<span class="var type0" id="S29T0U628">k</span>+1)) <span class="string">' degree in iteration '</span> num2str(<span class="var type0" id="S29T0U633">k</span>)]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T8:U328"><span class="var type1" id="S29T4U639">k</span>&gt;<span class="mxinfo " id="T4:U330">2</span></span> &amp;&amp; <span class="mxinfo " id="T8:U331"><span class="mxinfo " id="T4:U332"><span class="var type1" id="S28T15U643">theta</span>(<span class="mxinfo " id="T4:U334"><span class="var type1" id="S29T4U645">k</span>+<span class="mxinfo " id="T4:U336">1</span></span>)</span> &lt; <span class="mxinfo " id="T4:U337">10</span></span> &amp;&amp; <span class="mxinfo " id="T8:U338"><span class="mxinfo " id="T4:U339"><span class="var type1" id="S28T15U650">theta</span>(<span class="var type1" id="S29T4U651">k</span>)</span> &lt; <span class="mxinfo " id="T4:U342">10</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">            <span class="mxinfo " id="T24:U343"><span class="var type1" id="S56T24U655">d</span> = <span class="mxinfo " id="T24:U345">[<span class="mxinfo " id="T4:U346"><span class="var type1" id="S4T3U659">ER</span>(<span class="mxinfo " id="T4:U348"><span class="var type1" id="S29T4U661">k</span>+<span class="mxinfo " id="T4:U350">1</span></span>)</span>, <span class="mxinfo " id="T4:U351"><span class="var type1" id="S4T3U664">ER</span>(<span class="var type1" id="S29T4U665">k</span>)</span>, <span class="mxinfo " id="T4:U354"><span class="var type1" id="S4T3U667">ER</span>(<span class="mxinfo " id="T4:U356"><span class="var type1" id="S29T4U669">k</span>-<span class="mxinfo " id="T4:U358">1</span></span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">            <span class="mxinfo " id="T24:U359"><span class="var type1" id="S57T24U673">v</span> = <span class="mxinfo " id="T24:U361">[<span class="mxinfo " id="T4:U362">0</span>, <span class="mxinfo " id="T4:U363">-<span class="mxinfo " id="T4:U364">norm(<span class="mxinfo " id="T21:U365"><span class="var type1" id="S27T14U681">dq</span>(<span class="mxinfo " id="T22:U367">:</span>,<span class="mxinfo " id="T4:U368"><span class="var type1" id="S29T4U684">k</span>+<span class="mxinfo " id="T4:U370">1</span></span>)</span>)</span></span>, <span class="mxinfo " id="T4:U371"><span class="mxinfo " id="T4:U372">-<span class="mxinfo " id="T4:U373">norm(<span class="mxinfo " id="T21:U374"><span class="var type1" id="S27T14U691">dq</span>(<span class="mxinfo " id="T22:U376">:</span>,<span class="var type1" id="S29T4U693">k</span>)</span>)</span></span>-<span class="mxinfo " id="T4:U378">norm(<span class="mxinfo " id="T21:U379"><span class="var type1" id="S27T14U697">dq</span>(<span class="mxinfo " id="T22:U381">:</span>,<span class="mxinfo " id="T4:U382"><span class="var type1" id="S29T4U700">k</span>+<span class="mxinfo " id="T4:U384">1</span></span>)</span>)</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">            <span class="mxinfo " id="T4:U385"><span class="var type1" id="S58T4U704">vmax</span> = <span class="mxinfo " id="T4:U387"><span class="mxinfo " id="T4:U388">25</span> * <span class="mxinfo " id="T4:U389">norm(<span class="mxinfo " id="T21:U390"><span class="var type1" id="S27T14U710">dq</span>(<span class="mxinfo " id="T22:U392">:</span>,<span class="mxinfo " id="T4:U393"><span class="var type1" id="S29T4U713">k</span>+<span class="mxinfo " id="T4:U395">1</span></span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">            <span class="mxinfo " id="T4:U396"><span class="var type1" id="S59T4U717">dv</span> = <span class="mxinfo " id="T4:U398"><span class="fcn" id="F607N9:B719">extrapolate</span>(<span class="var type1" id="S57T24U720">v</span>,<span class="var type1" id="S56T24U721">d</span>,<span class="var type1" id="S58T4U722">vmax</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T8:U402"><span class="var type1" id="S59T4U726">dv</span> ~= <span class="mxinfo " id="T4:U404">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">                <span class="mxinfo " id="T21:U405"><span class="var type1" id="S61T21U730">q_mark</span> = <span class="mxinfo " id="T21:U407"><span class="mxinfo " id="T21:U408"><span class="var type1" id="S26T14U733">qq</span>(<span class="mxinfo " id="T22:U410">:</span>,<span class="mxinfo " id="T4:U411"><span class="var type1" id="S29T4U736">k</span>+<span class="mxinfo " id="T4:U413">1</span></span>)</span> + <span class="mxinfo " id="T21:U414"><span class="mxinfo " id="T21:U415"><span class="var type1" id="S59T4U740">dv</span> * <span class="mxinfo " id="T21:U417"><span class="var type1" id="S27T14U742">dq</span>(<span class="mxinfo " id="T22:U419">:</span>,<span class="mxinfo " id="T4:U420"><span class="var type1" id="S29T4U745">k</span>+<span class="mxinfo " id="T4:U422">1</span></span>)</span></span>/<span class="mxinfo " id="T4:U423">norm(<span class="mxinfo " id="T21:U424"><span class="var type1" id="S27T14U750">dq</span>(<span class="mxinfo " id="T22:U426">:</span>,<span class="mxinfo " id="T4:U427"><span class="var type1" id="S29T4U753">k</span>+<span class="mxinfo " id="T4:U429">1</span></span>)</span>)</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">                <span class="mxinfo " id="T25:U430"><span class="mxinfo " id="T25:U431"><span class="var type1" id="S61T21U758">q_mark</span>(<span class="mxinfo " id="T26:U433">1:4</span>)</span> = <span class="mxinfo " id="T23:U434"><span class="mxinfo " id="T23:U435"><span class="var type1" id="S61T21U764">q_mark</span>(<span class="mxinfo " id="T26:U437">1:4</span>)</span>/<span class="mxinfo " id="T4:U438">norm(<span class="mxinfo " id="T23:U439"><span class="var type1" id="S61T21U771">q_mark</span>(<span class="mxinfo " id="T26:U441">1:4</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">                <span class="mxinfo " id="T21:U442"><span class="mxinfo " id="T21:U443"><span class="var type1" id="S26T14U778">qq</span>(<span class="mxinfo " id="T22:U445">:</span>,<span class="mxinfo " id="T4:U446"><span class="var type1" id="S29T4U781">k</span>+<span class="mxinfo " id="T4:U448">1</span></span>)</span> = <span class="var type1" id="S61T21U783">q_mark</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">                <span class="mxinfo " id="T2:U450"><span class="mxinfo " id="T2:U451"><span class="var type1" id="S21T13U787">TR</span>(<span class="mxinfo " id="T19:U453">:</span>,<span class="mxinfo " id="T19:U454">:</span>,<span class="mxinfo " id="T4:U455"><span class="var type1" id="S29T4U791">k</span>+<span class="mxinfo " id="T4:U457">1</span></span>)</span> = <span class="mxinfo " id="T2:U458"><span class="fcn" id="F636N11:B794">quat2rmat</span>(<span class="mxinfo " id="T23:U459"><span class="var type1" id="S26T14U796">qq</span>(<span class="mxinfo " id="T27:U461">1:4</span>,<span class="mxinfo " id="T4:U462"><span class="var type1" id="S29T4U801">k</span>+<span class="mxinfo " id="T4:U464">1</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">                <span class="mxinfo " id="T1:U465"><span class="mxinfo " id="T1:U466"><span class="var type1" id="S20T12U806">TT</span>(<span class="mxinfo " id="T19:U468">:</span>,<span class="mxinfo " id="T20:U469">:</span>,<span class="mxinfo " id="T4:U470"><span class="var type1" id="S29T4U810">k</span>+<span class="mxinfo " id="T4:U472">1</span></span>)</span> = <span class="mxinfo " id="T1:U473"><span class="var type1" id="S26T14U813">qq</span>(<span class="mxinfo " id="T19:U475">5:7</span>,<span class="mxinfo " id="T4:U476"><span class="var type1" id="S29T4U818">k</span>+<span class="mxinfo " id="T4:U478">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">                <span class="comment">% Reapply total transformation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">                <span class="mxinfo " id="T5:U479"><span class="var type1" id="S15T5U822">pt</span> = <span class="mxinfo " id="T5:U481"><span class="mxinfo " id="T5:U482"><span class="mxinfo " id="T2:U483"><span class="var type1" id="S21T13U826">TR</span>(<span class="mxinfo " id="T19:U485">:</span>,<span class="mxinfo " id="T19:U486">:</span>,<span class="mxinfo " id="T4:U487"><span class="var type1" id="S29T4U830">k</span>+<span class="mxinfo " id="T4:U489">1</span></span>)</span> * <span class="var type1" id="S7T5U832">p</span></span> + <span class="mxinfo " id="T5:U491">repmat(<span class="mxinfo " id="T1:U492"><span class="var type1" id="S20T12U836">TT</span>(<span class="mxinfo " id="T19:U494">:</span>,<span class="mxinfo " id="T20:U495">:</span>,<span class="mxinfo " id="T4:U496"><span class="var type1" id="S29T4U840">k</span>+<span class="mxinfo " id="T4:U498">1</span></span>)</span>, 1, <span class="var type1" id="S13T4U843">Np</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">                <span class="comment">% Recalculate root mean of objective function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">                <span class="comment">% Note this is costly and only for fun!</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">                <span class="keyword">switch</span> <span class="var type1" id="S8T7U846">arg</span>.Matching</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">                    <span class="keyword">case</span> <span class="string">'bruteForce'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">                        [<span class="mxinfo " id="T17:U501">~</span>, <span class="var type1" id="S31T17U854">mindist</span>] = <span class="fcn" id="F121N10:B856">match_bruteForce</span>(<span class="var type1" id="S6T5U857">q</span>,<span class="var type1" id="S15T5U858">pt</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"><span class="comment">%                    case 'Delaunay'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="comment">%                        [~, mindist] = match_Delaunay(q,pt,DT);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="comment">%                    case 'kDtree'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"><span class="comment">%                        [~, mindist] = match_kDtree(q,pt,kdOBJ);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">                <span class="mxinfo " id="T4:U505"><span class="mxinfo " id="T4:U506"><span class="var type1" id="S4T3U862">ER</span>(<span class="mxinfo " id="T4:U508"><span class="var type1" id="S29T4U864">k</span>+<span class="mxinfo " id="T4:U510">1</span></span>)</span> = <span class="mxinfo " id="T4:U511">sqrt(<span class="mxinfo " id="T4:U512"><span class="mxinfo " id="T4:U513">sum(<span class="mxinfo " id="T17:U514"><span class="var type1" id="S31T17U872">mindist</span>.^2</span>)</span>/<span class="mxinfo " id="T4:U516">length(<span class="var type1" id="S31T17U876">mindist</span>)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">    <span class="comment">% t(k+1) = toc;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line"><span class="mxinfo " id="T2:U518"><span class="var type1" id="S3T2U879">Tr</span> = <span class="mxinfo " id="T2:U520"><span class="var type1" id="S21T13U881">TR</span>(<span class="mxinfo " id="T19:U522">:</span>,<span class="mxinfo " id="T19:U523">:</span>,<span class="mxinfo " id="T4:U524">end</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"><span class="mxinfo " id="T1:U525"><span class="var type1" id="S2T1U888">Tt</span> = <span class="mxinfo " id="T1:U527"><span class="var type1" id="S20T12U890">TT</span>(<span class="mxinfo " id="T19:U529">:</span>,<span class="mxinfo " id="T20:U530">:</span>,<span class="mxinfo " id="T4:U531">end</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"><span class="comment">%if not(arg.ReturnAll)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"><span class="comment">%	% 原来这样在Matlab Coder里会报Mismatch，这边只好加入一个临时变量，用于返回</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line"><span class="comment">%   % 这段也弃用</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line"><span class="comment">%    TR = TR(:,:,end);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line"><span class="comment">%    TT = TT(:,:,end);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line"><span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line"><span class="comment">% 暴力匹配</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line"></span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line">function [match mindist] = match_bruteForce(q, p)</span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">    m = size(p,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">    n = size(q,2);    </span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">    match = zeros(1,m);</span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">    mindist = zeros(1,m);</span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">    for ki=1:m</span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">        d=zeros(1,n);</span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">        for ti=1:3</span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">            d=d+(q(ti,:)-p(ti,ki)).^2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line">        [mindist(ki),match(ki)]=min(d);</span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">    mindist = sqrt(mindist);</span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">	</span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">function [R,T] = eq_point(q,p,weights)</span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">m = size(p,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">n = size(q,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line"><span class="comment">% normalize weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">weights = weights ./ sum(weights);</span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line"><span class="comment">% find data centroid and deviations from centroid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">q_bar = q * transpose(weights);</span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">q_mark = q - repmat(q_bar, 1, n);</span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line"><span class="comment">% Apply weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">q_mark = q_mark .* repmat(weights, 3, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line"><span class="comment">% find data centroid and deviations from centroid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line">p_bar = p * transpose(weights);</span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line">p_mark = p - repmat(p_bar, 1, m);</span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"><span class="comment">% Apply weights</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line"><span class="comment">%p_mark = p_mark .* repmat(weights, 3, 1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line">N = p_mark*transpose(q_mark); <span class="comment">% taking points of q in matched order</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line">[U,~,V] = svd(N); <span class="comment">% singular value decomposition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line">R = V*diag([1 1 det(U*V')])*transpose(U);</span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line">T = q_bar - R*p_bar;</span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line"><span class="comment">% Extrapolation in quaternion space. Details are found in:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line"><span class="comment">% Besl, P., &amp; McKay, N. (1992). A method for registration of 3-D shapes. </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line"><span class="comment">% IEEE Transactions on pattern analysis and machine intelligence, 239?256.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line">function [dv] = extrapolate(v,d,vmax)</span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line">p1 = polyfit(v,d,1); <span class="comment">% linear fit</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line">p2 = polyfit(v,d,2); <span class="comment">% parabolic fit</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line">v1 = -p1(2)/p1(1); <span class="comment">% linear zero crossing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line">v2 = -p2(2)/(2*p2(1)); <span class="comment">% polynomial top point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line">if issorted([0 v2 v1 vmax]) || issorted([0 v2 vmax v1])</span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line">    disp('Parabolic update!');</span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line">    dv = v2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line">elseif issorted([0 v1 v2 vmax]) || issorted([0 v1 vmax v2])...</span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line">        || (v2 &lt; 0 &amp;&amp; issorted([0 v1 vmax]))</span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line">    disp('Line based update!');</span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line">    dv = v1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line">elseif v1 &gt; vmax &amp;&amp; v2 &gt; vmax</span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line">    disp('Maximum update!');</span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line">    dv = vmax;</span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line">else</span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line">    disp('No extrapolation!');</span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line">    dv = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,252" id="srcline252">252</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,253" id="srcline253">253</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,254" id="srcline254">254</a></span><span class="line"><span class="comment">% Determine the RMS error between two point equally sized point clouds with</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,255" id="srcline255">255</a></span><span class="line"><span class="comment">% point correspondance.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,256" id="srcline256">256</a></span><span class="line"><span class="comment">% ER = rms_error(p1,p2) where p1 and p2 are 3xn matrices.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,257" id="srcline257">257</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,258" id="srcline258">258</a></span><span class="line">function ER = rms_error(p1,p2)</span></span>
<span class="srcline"><span class="lineno"><a href="1,259" id="srcline259">259</a></span><span class="line">dsq = sum(power(p1 - p2, 2),1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,260" id="srcline260">260</a></span><span class="line">ER = sqrt(mean(dsq));</span></span>
<span class="srcline"><span class="lineno"><a href="1,261" id="srcline261">261</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,262" id="srcline262">262</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,263" id="srcline263">263</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,264" id="srcline264">264</a></span><span class="line"><span class="comment">% Converts (orthogonal) rotation matrices R to (unit) quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,265" id="srcline265">265</a></span><span class="line"><span class="comment">% representations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,266" id="srcline266">266</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,267" id="srcline267">267</a></span><span class="line"><span class="comment">% Input: A 3x3xn matrix of rotation matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,268" id="srcline268">268</a></span><span class="line"><span class="comment">% Output: A 4xn matrix of n corresponding quaternions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,269" id="srcline269">269</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,270" id="srcline270">270</a></span><span class="line"><span class="comment">% http://en.wikipedia.org/wiki/Rotation_matrix#Quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,271" id="srcline271">271</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,272" id="srcline272">272</a></span><span class="line">function quaternion = rmat2quat(R)</span></span>
<span class="srcline"><span class="lineno"><a href="1,273" id="srcline273">273</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,274" id="srcline274">274</a></span><span class="line">Qxx = R(1,1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,275" id="srcline275">275</a></span><span class="line">Qxy = R(1,2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,276" id="srcline276">276</a></span><span class="line">Qxz = R(1,3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,277" id="srcline277">277</a></span><span class="line">Qyx = R(2,1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line">Qyy = R(2,2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line">Qyz = R(2,3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line">Qzx = R(3,1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line">Qzy = R(3,2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line">Qzz = R(3,3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line">w = 0.5 * sqrt(1+Qxx+Qyy+Qzz);</span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line">x = 0.5 * sign(Qzy-Qyz) .* sqrt(1+Qxx-Qyy-Qzz);</span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line">y = 0.5 * sign(Qxz-Qzx) .* sqrt(1-Qxx+Qyy-Qzz);</span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line">z = 0.5 * sign(Qyx-Qxy) .* sqrt(1-Qxx-Qyy+Qzz);</span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line">quaternion = reshape([w;x;y;z],4,[]);</span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line"><span class="comment">% Converts (unit) quaternion representations to (orthogonal) rotation matrices R</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line"><span class="comment">% Input: A 4xn matrix of n quaternions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line"><span class="comment">% Output: A 3x3xn matrix of corresponding rotation matrices</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,297" id="srcline297">297</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,298" id="srcline298">298</a></span><span class="line"><span class="comment">% http://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation#From_a_quaternion_to_an_orthogonal_matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,299" id="srcline299">299</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,300" id="srcline300">300</a></span><span class="line">function R = quat2rmat(quaternion)</span></span>
<span class="srcline"><span class="lineno"><a href="1,301" id="srcline301">301</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,302" id="srcline302">302</a></span><span class="line"><span class="comment">% 这里增加一个初始化，这边敢这么设置是因为这个东西本身就是二维的</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,303" id="srcline303">303</a></span><span class="line">q0 = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,304" id="srcline304">304</a></span><span class="line">qx = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,305" id="srcline305">305</a></span><span class="line">qy = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,306" id="srcline306">306</a></span><span class="line">qz = zeros(1, 1, 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,307" id="srcline307">307</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,308" id="srcline308">308</a></span><span class="line">q0(1,1,:) = quaternion(1,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,309" id="srcline309">309</a></span><span class="line">qx(1,1,:) = quaternion(2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,310" id="srcline310">310</a></span><span class="line">qy(1,1,:) = quaternion(3,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,311" id="srcline311">311</a></span><span class="line">qz(1,1,:) = quaternion(4,:);</span></span>
<span class="srcline"><span class="lineno"><a href="1,312" id="srcline312">312</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,313" id="srcline313">313</a></span><span class="line">R = [q0.^2+qx.^2-qy.^2-qz.^2 2*qx.*qy-2*q0.*qz 2*qx.*qz+2*q0.*qy;</span></span>
<span class="srcline"><span class="lineno"><a href="1,314" id="srcline314">314</a></span><span class="line">     2*qx.*qy+2*q0.*qz q0.^2-qx.^2+qy.^2-qz.^2 2*qy.*qz-2*q0.*qx;</span></span>
<span class="srcline"><span class="lineno"><a href="1,315" id="srcline315">315</a></span><span class="line">     2*qx.*qz-2*q0.*qy 2*qy.*qz+2*q0.*qx q0.^2-qx.^2-qy.^2+qz.^2];</span></span>
<span class="srcline"><span class="lineno"><a href="1,316" id="srcline316">316</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,317" id="srcline317">317</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,318" id="srcline318">318</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,319" id="srcline319">319</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,320" id="srcline320">320</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>
